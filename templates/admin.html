{% extends "base.html" %}

{% block hero %}
<div class="hero-grid">
    <div class="hero-copy">
        <p class="eyebrow">Site operations</p>
        <h1>Admin dashboard</h1>
        <p class="lede">Manage the experience for visitors here. Add calming resources, keep the bookshelf updated, and review engagement.</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="admin-page" data-admin-scroll-target="{{ active_section }}">
    <div class="admin-anchor-nav" aria-label="Admin shortcuts">
        <a class="btn tiny ghost" href="#site-banner">Site banner</a>
        <a class="btn tiny ghost" href="#ai-tools">AI tools</a>
        <a class="btn tiny ghost" href="#chat-room">Chat room</a>
        <a class="btn tiny ghost" href="#data">Data</a>
        <a class="btn tiny ghost" href="#media-library">Media pot</a>
        <a class="btn tiny ghost" href="#did-you-know">Did you know?</a>
        <a class="btn tiny ghost" href="#useful-contacts">Useful contacts</a>
        <a class="btn tiny ghost" href="#activities">Activities</a>
        <a class="btn tiny ghost" href="#charities">Charities</a>
        <a class="btn tiny ghost" href="#books">Books</a>
        <a class="btn tiny ghost" href="#book-shelf">Live shelf</a>
    </div>

    <section class="panel admin-panel" id="site-banner" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Announcements</p>
        <h2>Control the site banner.</h2>
        <p class="lede">Toggle a sitewide notice for visitors.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('update_site_banner') }}" method="post">
        <div class="checkbox-grid">
            <label class="checkbox-field">
                <input type="checkbox" name="construction_banner" {% if construction_banner_enabled %}checked{% endif %} />
                <span>Display ‚ÄúTHIS SITE IS UNDER CONSTRUCTION‚Äù</span>
            </label>
        </div>
        <p class="form-hint">Appears above the navigation on every page.</p>
        <button class="btn" type="submit">
            {% if construction_banner_enabled %}Turn banner off{% else %}Turn banner on{% endif %}
        </button>
    </form>
    </section>

    <section class="panel admin-panel" id="ai-tools" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">AI helpers</p>
        <h2>Save a DeepSeek API key.</h2>
        <p class="lede">Store a key securely in the database so you can enrich charity listings with one click.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('update_deepseek_api_key') }}" method="post">
        <div class="form-grid">
            <label>
                <span>DeepSeek API key</span>
                <input type="password" name="deepseek_api_key" placeholder="sk-..." value="{{ deepseek_api_key }}" />
                <p class="body muted">Stored in the site settings table. Current key: {{ deepseek_api_key_masked or 'None' }}.</p>
            </label>
        </div>
        <button class="btn" type="submit">Save key</button>
    </form>
    </section>

    <section class="panel admin-panel" id="chat-room" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Chat Room</p>
        <h2>Manage the community chat.</h2>
        <p class="lede">Control when the chat room is open and set the topic for each session.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('update_chat_settings') }}" method="post">
        <div class="checkbox-grid">
            <label class="checkbox-field">
                <input type="checkbox" name="chat_enabled" {% if chat_enabled %}checked{% endif %} />
                <span>Chat room is open</span>
            </label>
        </div>
        <p class="form-hint">When off, visitors will see when the next session is scheduled.</p>
        <div class="form-grid">
            <label>
                <span>Current topic</span>
                <input type="text" name="chat_topic" placeholder="e.g. Coping with anxiety" value="{{ chat_topic }}" />
                <p class="body muted">Displayed to visitors when they enter the chat room.</p>
            </label>
            <label>
                <span>Next session</span>
                <input type="text" name="chat_next_session" placeholder="e.g. Tuesday 7pm GMT - Managing stress" value="{{ chat_next_session }}" />
                <p class="body muted">Shown when chat is closed. Include date, time and topic.</p>
            </label>
        </div>
        <button class="btn" type="submit">Save chat settings</button>
    </form>
    </section>

    <section class="panel admin-panel" id="data" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Data</p>
        <h2>Manage saved content.</h2>
        <p class="lede">Save the current catalog to local storage or reload the last snapshot. Messages below confirm what changed.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <div class="data-actions">
        <form action="{{ url_for('snapshot_save') }}" method="post">
            <button class="btn secondary" type="submit">Save data</button>
        </form>
        <form action="{{ url_for('snapshot_load') }}" method="post">
            <button class="btn ghost" type="submit">Load data</button>
        </form>
    </div>
    <div class="snapshot-grid">
        {% if save_summary %}
        <div class="snapshot-card">
            <div class="panel-header compact">
                <p class="eyebrow">Saved</p>
                <h3>Latest save snapshot</h3>
                <p class="lede">Here is what was written to local storage.</p>
            </div>
            <div class="table-scroll">
                <table class="snapshot-table">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Book</th>
                            <th scope="col">Author</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for book in save_summary.books %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ book.title }}</td>
                            <td>{{ book.author or "‚Äî" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% if load_summary %}
        <div class="snapshot-card">
            <div class="panel-header compact">
                <p class="eyebrow">Loaded</p>
                <h3>Latest load snapshot</h3>
                <p class="lede">The items pulled from storage just now.</p>
            </div>
            <div class="table-scroll">
                <table class="snapshot-table">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Book</th>
                            <th scope="col">Author</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for book in load_summary.books %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ book.title }}</td>
                            <td>{{ book.author or "‚Äî" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    </section>

    <section class="panel admin-panel" id="media-library" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Media pot</p>
        <h2>Save reusable images and videos.</h2>
        <p class="lede">Give each upload a name so you can reference it anywhere in the codebase with <code>get_media_asset</code> or <code>media_lookup</code>.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('add_media_asset') }}" method="post" enctype="multipart/form-data">
        <div class="form-grid">
            <label>
                <span>Asset name</span>
                <input type="text" name="name" placeholder="home-hero-image" required />
            </label>
            <label class="select-wrapper">
                <span>Type</span>
                <select name="media_type" required>
                    <option value="image" selected>Image</option>
                    <option value="video">Video</option>
                </select>
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Link to file (optional)</span>
                <input type="url" name="url" placeholder="https://..." />
            </label>
            <label>
                <span>Description (optional)</span>
                <input type="text" name="description" placeholder="Where and how this media is used" />
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Upload a file (optional)</span>
                <input type="file" name="file" accept="image/*,video/*" />
            </label>
        </div>
        <p class="form-hint">Upload a file or provide a link. Example: <code>get_media_asset('calming-video')</code> returns the saved link and type wherever you need it.</p>
        <button class="btn" type="submit">Add media</button>
    </form>
    <div class="media-admin-grid">
        {% for asset in media_assets %}
        <article class="charity-card admin-card media-card">
            <div class="charity-header">
                <div class="media-thumb" aria-hidden="true">
                    {% if asset.media_type == 'image' %}
                    <img src="{{ asset.url }}" alt="" loading="lazy" />
                    {% else %}
                    <div class="media-thumb__placeholder">üé¨</div>
                    {% endif %}
                </div>
                <div>
                    <p class="eyebrow">{{ asset.media_type|capitalize }} asset</p>
                    <h3>{{ asset.name }}</h3>
                </div>
            </div>
            <p class="body">{{ asset.description or "No description yet." }}</p>
            <p class="microcopy media-url">{{ asset.url }}</p>
            <div class="book-actions">
                <a class="btn tiny" href="{{ asset.url }}" target="_blank" rel="noopener">Open link</a>
                <button
                    class="btn tiny secondary"
                    type="button"
                    data-media-edit-toggle
                    data-target="media-{{ asset.id }}"
                    aria-expanded="false"
                >
                    Edit
                </button>
                <form action="{{ url_for('delete_media_asset', asset_id=asset.id) }}" method="post" onsubmit="return confirm('Delete this media asset?');">
                    <button class="btn tiny ghost" type="submit">Delete</button>
                </form>
                <div class="halo"></div>
            </div>
            <form
                class="admin-inline-form hidden"
                data-media-form="media-{{ asset.id }}"
                action="{{ url_for('update_media_asset', asset_id=asset.id) }}"
                method="post"
                enctype="multipart/form-data"
            >
                <div class="form-grid">
                    <label>
                        <span>Asset name</span>
                        <input type="text" name="name" value="{{ asset.name }}" required />
                    </label>
                    <label class="select-wrapper">
                        <span>Type</span>
                        <select name="media_type" required>
                            <option value="image" {% if asset.media_type == 'image' %}selected{% endif %}>Image</option>
                            <option value="video" {% if asset.media_type == 'video' %}selected{% endif %}>Video</option>
                        </select>
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Link to file (optional)</span>
                        <input type="url" name="url" value="{{ asset.url }}" />
                    </label>
                    <label>
                        <span>Description (optional)</span>
                        <input type="text" name="description" value="{{ asset.description }}" />
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Upload a file (optional)</span>
                        <input type="file" name="file" accept="image/*,video/*" />
                    </label>
                </div>
                <div class="book-actions">
                    <button class="btn tiny" type="submit">Save changes</button>
                    <button class="btn tiny ghost" type="button" data-media-edit-toggle data-target="media-{{ asset.id }}">Cancel</button>
                </div>
            </form>
        </article>
        {% else %}
        <p class="body">No media saved yet. Add an image or video link and reuse it by name anywhere on the site.</p>
        {% endfor %}
    </div>
    </section>

    <section class="panel admin-panel" id="did-you-know" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Did you know?</p>
        <h2>Share quick, hopeful facts.</h2>
        <p class="lede">Add or edit the ‚ÄúDid you know?‚Äù tiles on the homepage. Include a short headline, an optional detail, and a call-to-action link.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('add_did_you_know_item') }}" method="post">
        <div class="form-grid">
            <label>
                <span>Headline</span>
                <input type="text" name="headline" placeholder="Did you know..." required />
            </label>
            <label>
                <span>Call-to-action label (optional)</span>
                <input type="text" name="cta_label" placeholder="Call now, Text for support" />
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Detail (optional)</span>
                <textarea name="detail" rows="2" placeholder="Add a short explanation or reassurance."></textarea>
            </label>
            <label>
                <span>Link (optional)</span>
                <input type="text" name="cta_url" placeholder="https://... or tel:111" />
            </label>
        </div>
        <button class="btn" type="submit">Add card</button>
    </form>
    <div class="did-you-know-admin-grid">
        {% for item in did_you_know_items %}
        <article class="charity-card admin-card did-you-know-admin-card">
            <div class="charity-header">
                <div>
                    <p class="eyebrow">Homepage card</p>
                    <h3>{{ item.headline }}</h3>
                </div>
                <div class="pill tiny ghost">{{ item.cta_label or 'No CTA' }}</div>
            </div>
            <p class="body">{{ item.detail or 'No detail yet.' }}</p>
            <div class="book-actions">
                <button
                    class="btn tiny secondary"
                    type="button"
                    data-didyouknow-edit-toggle
                    data-target="did-you-know-{{ item.id }}"
                    aria-expanded="false"
                >
                    Edit
                </button>
                <form action="{{ url_for('delete_did_you_know_item', item_id=item.id) }}" method="post" onsubmit="return confirm('Delete this card?');">
                    <button class="btn tiny ghost" type="submit">Delete</button>
                </form>
                <div class="halo"></div>
            </div>
            <form
                class="admin-inline-form hidden"
                data-didyouknow-form="did-you-know-{{ item.id }}"
                action="{{ url_for('update_did_you_know_item', item_id=item.id) }}"
                method="post"
            >
                <div class="form-grid">
                    <label>
                        <span>Headline</span>
                        <input type="text" name="headline" value="{{ item.headline }}" required />
                    </label>
                    <label>
                        <span>Call-to-action label (optional)</span>
                        <input type="text" name="cta_label" value="{{ item.cta_label }}" />
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Detail</span>
                        <textarea name="detail" rows="2">{{ item.detail }}</textarea>
                    </label>
                    <label>
                        <span>Link</span>
                        <input type="text" name="cta_url" value="{{ item.cta_url }}" />
                    </label>
                </div>
                <div class="book-actions">
                    <button class="btn tiny" type="submit">Save changes</button>
                    <button class="btn tiny ghost" type="button" data-didyouknow-edit-toggle data-target="did-you-know-{{ item.id }}">Cancel</button>
                </div>
            </form>
        </article>
        {% else %}
        <p class="body">No ‚ÄúDid you know?‚Äù cards yet. Add a few to brighten the homepage.</p>
        {% endfor %}
    </div>
    </section>

    <section class="panel admin-panel" id="useful-contacts" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Useful contacts</p>
        <h2>Keep helplines and text numbers current.</h2>
        <p class="lede">Add trusted services manually or ask the AI to suggest a new one. We‚Äôll skip duplicates to keep the list tidy.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('add_useful_contact_admin') }}" method="post">
        <div class="form-grid">
            <label>
                <span>Service name</span>
                <input type="text" name="name" placeholder="Example Helpline" required />
            </label>
            <label>
                <span>Telephone</span>
                <input type="text" name="telephone" placeholder="111, 0800..." />
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Email (optional)</span>
                <input type="email" name="contact_email" placeholder="support@example.org" />
            </label>
            <label>
                <span>Text number (optional)</span>
                <input type="text" name="text_number" placeholder="Text code or SMS number" />
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Tags (comma separated)</span>
                <input type="text" name="tags" placeholder="crisis, youth, uk" />
            </label>
            <label>
                <span>Description (optional)</span>
                <input type="text" name="description" placeholder="Hours, audience, or speciality" />
            </label>
        </div>
        <button class="btn" type="submit">Add contact</button>
    </form>
    <div class="admin-inline-actions">
        <form class="admin-form compact" action="{{ url_for('ai_useful_contact_admin') }}" method="post">
            <div class="form-grid">
                <label>
                    <span>Ask AI for a new contact</span>
                    <input type="text" name="topic" placeholder="e.g., text-based crisis line in the UK" />
                    <p class="microcopy">Requires a DeepSeek key. AI will avoid duplicates and only return one strong match.</p>
                </label>
            </div>
            <button class="btn secondary" type="submit">Request contact</button>
        </form>
    </div>
    <div class="charity-admin-grid">
        {% for contact in useful_contacts %}
        <article class="charity-card admin-card">
            <div class="charity-header">
                <div>
                    <p class="eyebrow">Useful contact</p>
                    <h3>{{ contact.name }}</h3>
                </div>
                <div class="chip-row">
                    {% for tag in contact.all_tags %}
                    <span class="chip">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            <dl class="contact-dl">
                <div>
                    <dt>Call</dt>
                    <dd>{{ contact.telephone or '‚Äî' }}</dd>
                </div>
                <div>
                    <dt>Text</dt>
                    <dd>{{ contact.text_number or '‚Äî' }}</dd>
                </div>
                <div>
                    <dt>Email</dt>
                    <dd>{{ contact.contact_email or '‚Äî' }}</dd>
                </div>
            </dl>
            <p class="body">{{ contact.description or 'No description added yet.' }}</p>
            <div class="book-actions">
                <button
                    class="btn tiny secondary"
                    type="button"
                    data-contact-edit-toggle
                    data-target="contact-{{ contact.id }}"
                    aria-expanded="false"
                >
                    Edit
                </button>
                <form action="{{ url_for('delete_useful_contact_admin', contact_id=contact.id) }}" method="post" onsubmit="return confirm('Delete this contact?');">
                    <button class="btn tiny ghost" type="submit">Delete</button>
                </form>
                <div class="halo"></div>
            </div>
            <form
                class="admin-inline-form hidden"
                data-contact-form="contact-{{ contact.id }}"
                action="{{ url_for('update_useful_contact_admin', contact_id=contact.id) }}"
                method="post"
            >
                <div class="form-grid">
                    <label>
                        <span>Service name</span>
                        <input type="text" name="name" value="{{ contact.name }}" required />
                    </label>
                    <label>
                        <span>Telephone</span>
                        <input type="text" name="telephone" value="{{ contact.telephone }}" />
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Email</span>
                        <input type="email" name="contact_email" value="{{ contact.contact_email }}" />
                    </label>
                    <label>
                        <span>Text number</span>
                        <input type="text" name="text_number" value="{{ contact.text_number }}" />
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Tags</span>
                        <input type="text" name="tags" value="{{ contact.tags }}" />
                    </label>
                    <label>
                        <span>Description</span>
                        <input type="text" name="description" value="{{ contact.description }}" />
                    </label>
                </div>
                <div class="book-actions">
                    <button class="btn tiny" type="submit">Save changes</button>
                    <button class="btn tiny ghost" type="button" data-contact-edit-toggle data-target="contact-{{ contact.id }}">Cancel</button>
                </div>
            </form>
        </article>
        {% else %}
        <p class="body">No contacts yet. Add a helpline or ask the AI for a suggestion.</p>
        {% endfor %}
    </div>
    </section>

    <section class="panel admin-panel" id="activities" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Activities</p>
        <h2>List what different charities offer.</h2>
        <p class="lede">Add group sessions, coffee mornings, workshops, and more without tying them to the main charity directory.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <form class="admin-form" action="{{ url_for('add_charity_activity') }}" method="post">
        <div class="form-grid">
            <label>
                <span>Organisation</span>
                <input type="text" name="organisation_name" placeholder="Charity or group name" required />
            </label>
            <label>
                <span>Activity</span>
                <input type="text" name="activity_name" placeholder="e.g., Coffee morning" required />
            </label>
        </div>
        <div class="form-grid">
            <label>
                <span>Type or format (optional)</span>
                <input type="text" name="activity_type" placeholder="Drop-in, online, weekly" />
            </label>
            <label>
                <span>Details</span>
                <input type="text" name="details" placeholder="What to expect or how to join" />
            </label>
        </div>
        <button class="btn" type="submit">Add activity</button>
    </form>
    <div class="charity-admin-grid">
        {% for activity in charity_activities %}
        <article class="charity-card admin-card">
            <div class="charity-header">
                <div>
                    <p class="eyebrow">{{ activity.organisation_name }}</p>
                    <h3>{{ activity.activity_name }}</h3>
                </div>
                {% if activity.activity_type %}
                <span class="pill tiny ghost">{{ activity.activity_type }}</span>
                {% endif %}
            </div>
            <p class="body">{{ activity.details or "No details provided yet." }}</p>
            <div class="book-actions">
                <button
                    class="btn tiny secondary"
                    type="button"
                    data-activity-edit-toggle
                    data-target="activity-{{ activity.id }}"
                    aria-expanded="false"
                >
                    Edit
                </button>
                <form action="{{ url_for('delete_charity_activity', activity_id=activity.id) }}" method="post" onsubmit="return confirm('Delete this activity?');">
                    <button class="btn tiny ghost" type="submit">Delete</button>
                </form>
                <div class="halo"></div>
            </div>
            <form
                class="admin-inline-form hidden"
                data-activity-form="activity-{{ activity.id }}"
                action="{{ url_for('update_charity_activity', activity_id=activity.id) }}"
                method="post"
            >
                <div class="form-grid">
                    <label>
                        <span>Organisation</span>
                        <input type="text" name="organisation_name" value="{{ activity.organisation_name }}" required />
                    </label>
                    <label>
                        <span>Activity</span>
                        <input type="text" name="activity_name" value="{{ activity.activity_name }}" required />
                    </label>
                </div>
                <div class="form-grid">
                    <label>
                        <span>Type or format (optional)</span>
                        <input type="text" name="activity_type" value="{{ activity.activity_type or '' }}" />
                    </label>
                    <label>
                        <span>Details</span>
                        <input type="text" name="details" value="{{ activity.details or '' }}" />
                    </label>
                </div>
                <div class="book-actions">
                    <button class="btn tiny" type="submit">Save changes</button>
                    <button
                        class="btn tiny ghost"
                        type="button"
                        data-activity-edit-toggle
                        data-target="activity-{{ activity.id }}"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </article>
        {% else %}
        <p class="body">No activities yet. Add one to populate the dropdown on the Activities page.</p>
        {% endfor %}
    </div>
    </section>

    <section class="panel admin-panel" id="charities" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Charities</p>
        <h2>Highlight trusted organisations.</h2>
        <p class="lede">Add logos, descriptions, and links. These appear on the homepage and the dedicated charities page.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <div class="data-actions">
        <button
            class="btn"
            type="button"
            data-admin-charity-open
            data-action="{{ url_for('add_charity') }}"
            data-modal-title="Add a charity"
            data-submit-label="Save charity"
        >
            Add charity
        </button>
    </div>
    <div class="charity-admin-grid">
        {% for charity in charities %}
        <article class="charity-card admin-card">
            <div class="charity-header">
                <div class="charity-logo" aria-hidden="true">
                    {% if charity.logo_url %}
                    <img src="{{ charity.logo_url }}" alt="" loading="lazy" />
                    {% endif %}
                    <div class="logo-fallback {% if charity.logo_url %}hidden{% endif %}">ü§ù</div>
                </div>
                <div>
                    <p class="eyebrow">Charity</p>
                    <h3>{{ charity.name }}</h3>
                </div>
            </div>
            <p class="body">{{ charity.description }}</p>
            <div class="charity-actions">
                <a class="btn tiny" href="{{ charity.website_url }}" target="_blank" rel="noopener">Open link</a>
                <div class="book-actions">
                    <form action="{{ url_for('enrich_charity', charity_id=charity.id) }}" method="post">
                        <button class="btn tiny" type="submit">AI enrich</button>
                    </form>
                    <button
                        class="btn tiny secondary"
                        type="button"
                        data-admin-charity-open
                        data-action="{{ url_for('update_charity', charity_id=charity.id) }}"
                        data-modal-title="Edit charity"
                        data-submit-label="Update charity"
                        data-charity-name="{{ charity.name }}"
                        data-charity-description="{{ charity.description }}"
                        data-charity-logo="{{ charity.logo_url }}"
                        data-charity-website="{{ charity.website_url }}"
                        data-charity-telephone="{{ charity.telephone }}"
                        data-charity-contact-email="{{ charity.contact_email }}"
                        data-charity-text-number="{{ charity.text_number }}"
                        data-charity-helpline-hours="{{ charity.helpline_hours }}"
                        data-charity-has-helpline="{{ charity.has_helpline }}"
                        data-charity-has-volunteers="{{ charity.has_volunteers }}"
                        data-charity-has-crisis-info="{{ charity.has_crisis_info }}"
                        data-charity-has-text-support="{{ charity.has_text_support }}"
                        data-charity-has-email-support="{{ charity.has_email_support }}"
                        data-charity-has-live-chat="{{ charity.has_live_chat }}"
                    >
                        Edit
                    </button>
                    <form action="{{ url_for('delete_charity', charity_id=charity.id) }}" method="post" onsubmit="return confirm('Delete this charity?');">
                        <button class="btn tiny ghost" type="submit">Delete</button>
                    </form>
                    <div class="halo"></div>
                </div>
            </div>
        </article>
        {% else %}
        <p class="body">No charities yet. Add one to spotlight it on the homepage.</p>
        {% endfor %}
    </div>
    </section>

    <section class="panel admin-panel" id="books" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Books</p>
        <h2>Add a useful book.</h2>
        <p class="lede">Include the title, author, affiliate link, and a short description. Covers are optional but make the list feel welcoming.</p>
    </div>
    <div class="data-actions">
        <form action="{{ url_for('delete_all_books') }}" method="post" onsubmit="return confirm('Delete all books?');">
            <button class="btn ghost" type="submit">Delete all books</button>
        </form>
    </div>
    <form class="admin-form" action="{{ url_for('scrape_book') }}" method="post">
        <label>
            <span>Scrape from a book URL</span>
            <input type="url" name="book_url" placeholder="https://" required />
            <p class="body muted">We'll fetch Open Graph metadata for the title, description, and cover. The link will be saved as the purchase URL.</p>
        </label>
        <button class="btn" type="submit">Scrape &amp; add book</button>
    </form>
    <form class="admin-form" action="{{ url_for('add_book') }}" method="post">
        <div class="form-grid">
            <label>
                <span>Title</span>
                <input type="text" name="title" placeholder="Book title" required />
            </label>
            <label>
                <span>Author</span>
                <input type="text" name="author" placeholder="Author name" required />
            </label>
        </div>
        <label>
            <span>Short description</span>
            <textarea name="description" rows="3" placeholder="Why this book helps" required></textarea>
        </label>
        <div class="form-grid">
            <label>
                <span>Affiliate or purchase link</span>
                <input type="url" name="affiliate_url" placeholder="https://" required />
            </label>
            <label>
                <span>Cover image URL (optional)</span>
                <input type="url" name="cover_url" placeholder="https://.../cover.jpg" />
            </label>
            <label class="select-wrapper">
                <span>Or pick from the media pot</span>
                <select name="cover_asset_url" data-media-url-select data-target-input="cover_url">
                    <option value="">Choose a saved image</option>
                    {% for asset in media_assets if asset.media_type == 'image' %}
                    <option value="{{ asset.url }}">{{ asset.name }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <button class="btn" type="submit">Add book</button>
    </form>
    </section>

    <section class="panel book-panel admin-book-panel" id="book-shelf" data-admin-section>
    <div class="panel-header">
        <p class="eyebrow">Live shelf</p>
        <h2>Books visitors can browse</h2>
        <p class="lede">Edit or remove any book. Updates appear instantly on the homepage shelf and the books page.</p>
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}
    </div>
    <div class="admin-stats">
        <div class="stat-card">
            <p class="eyebrow">Total books</p>
            <p class="stat-number">{{ books|length }}</p>
            <p class="stat-helper">Across the whole shelf</p>
        </div>
        <div class="stat-card">
            <p class="eyebrow">Books per row</p>
            <p class="stat-number">{{ books_per_row }}</p>
            <p class="stat-helper">Shown on desktop widths</p>
        </div>
        <div class="stat-card">
            <p class="eyebrow">Cover readiness</p>
            <p class="stat-number">{{ books_with_covers }}/{{ books|length }}</p>
            <p class="stat-helper">{{ books_without_covers }} missing covers</p>
        </div>
    </div>

    <div class="book-metrics-table-wrapper">
        <div class="panel-header compact">
            <p class="eyebrow">Calming tools</p>
            <h3>Usage across exercises</h3>
            <p class="lede">Track how many times visitors mark a practice as completed.</p>
        </div>
        <div class="table-scroll">
            <table class="book-metrics-table">
                <thead>
                    <tr>
                        <th scope="col">Exercise</th>
                        <th scope="col">Guided starts</th>
                        <th scope="col">Completed taps</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tool in calming_tools %}
                    <tr>
                        <td>{{ tool.title }}</td>
                        <td>{{ tool.view_count }}</td>
                        <td>{{ tool.completed_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="book-grid" style="--admin-book-columns: {{ books_per_row }}">
        {% for book in books %}
        <article class="book-card">
            <div class="book-cover" aria-hidden="true">
                {% if book.cover_url %}
                <img src="{{ book.cover_url }}" alt="{{ book.title }} cover" loading="lazy" />
                {% else %}
                <div class="cover-placeholder">üìñ</div>
                {% endif %}
            </div>
            <div class="book-meta">
                <div class="book-meta-header">
                    <p class="eyebrow">{{ book.author }}</p>
                    <span class="pill tiny ghost book-view-pill">{{ book.view_count }} views</span>
                </div>
                <h3>{{ book.title }}</h3>
                <p class="body book-admin-description">{{ book.description }}</p>
            </div>
            <div class="book-admin-footer">
                <div class="book-actions">
                    <a class="btn tiny" href="{{ book.affiliate_url }}" target="_blank" rel="noopener">View book</a>
                    <form action="{{ url_for('delete_book', book_index=loop.index0) }}" method="post">
                        <button class="btn tiny ghost" type="submit">Remove</button>
                    </form>
                    <button
                        class="btn tiny secondary"
                        type="button"
                        data-admin-book-edit-trigger
                        data-action="{{ url_for('update_book', book_index=loop.index0) }}"
                        data-title="{{ book.title }}"
                        data-author="{{ book.author }}"
                        data-description="{{ book.description }}"
                        data-affiliate-url="{{ book.affiliate_url }}"
                        data-cover-url="{{ book.cover_url }}"
                    >
                        Edit book
                    </button>
                    <div class="halo"></div>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
    </section>
</div>

<div class="modal-backdrop admin-edit-modal" data-admin-book-modal>
    <div class="modal-dialog admin-modal" role="dialog" aria-modal="true" aria-labelledby="adminBookModalTitle">
        <div class="book-modal-glow"></div>
        <div class="modal-header">
            <div>
                <p class="eyebrow">Edit book</p>
                <h3 id="adminBookModalTitle">Update book details</h3>
                <p class="body muted">Refresh the book card with a new title, cover, or link. Changes save instantly.</p>
            </div>
            <button class="modal-close" type="button" aria-label="Close edit dialog" data-admin-book-modal-close>&times;</button>
        </div>
        <form class="admin-form compact" method="post" data-admin-book-form>
            <div class="modal-grid">
                <label>
                    <span>Title</span>
                    <input type="text" name="title" required />
                </label>
                <label>
                    <span>Author</span>
                    <input type="text" name="author" required />
                </label>
            </div>
            <label>
                <span>Description</span>
                <textarea name="description" rows="3" required></textarea>
            </label>
            <div class="modal-grid">
                <label>
                    <span>Affiliate link</span>
                    <input type="url" name="affiliate_url" required />
                </label>
                <label>
                    <span>Cover image URL</span>
                    <input type="url" name="cover_url" />
                </label>
                <label class="select-wrapper">
                    <span>Or pick from the media pot</span>
                    <select name="cover_asset_url" data-media-url-select data-target-input="cover_url">
                        <option value="">Choose a saved image</option>
                        {% for asset in media_assets if asset.media_type == 'image' %}
                        <option value="{{ asset.url }}">{{ asset.name }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="form-actions">
                <button class="btn" type="submit">Save changes</button>
                <button class="btn ghost" type="button" data-admin-book-modal-close>Cancel</button>
                <span class="helper">Leave the cover field empty to keep the current image.</span>
            </div>
        </form>
    </div>
</div>

<div class="modal-backdrop admin-edit-modal" data-admin-charity-modal>
    <div class="modal-dialog admin-modal" role="dialog" aria-modal="true" aria-labelledby="adminCharityModalTitle">
        <div class="book-modal-glow"></div>
        <div class="modal-header">
            <div>
                <p class="eyebrow">Charity</p>
                <h3 id="adminCharityModalTitle" data-admin-charity-modal-title>Add a charity</h3>
                <p class="body muted">Share the essentials: name, logo, a short description, and where to learn more.</p>
            </div>
            <button class="modal-close" type="button" aria-label="Close charity dialog" data-admin-charity-close>&times;</button>
        </div>
        <form class="admin-form compact" method="post" data-admin-charity-form action="{{ url_for('add_charity') }}">
            <label>
                <span>Name</span>
                <input type="text" name="name" required />
            </label>
            <label>
                <span>Description</span>
                <textarea name="description" rows="3" required></textarea>
            </label>
            <div class="modal-grid">
                <label>
                    <span>Logo URL (optional)</span>
                    <input type="url" name="logo_url" placeholder="https://.../logo.png" />
                </label>
                <label class="select-wrapper">
                    <span>Or pick from the media pot</span>
                    <select name="logo_asset_url" data-media-url-select data-target-input="logo_url">
                        <option value="">Choose a saved image</option>
                        {% for asset in media_assets if asset.media_type == 'image' %}
                        <option value="{{ asset.url }}">{{ asset.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    <span>Website link</span>
                    <input type="url" name="website_url" placeholder="https://" required />
                </label>
            </div>
            <div class="modal-grid">
                <label>
                    <span>Telephone (optional)</span>
                    <input type="text" name="telephone" placeholder="+44 1234 567890" />
                </label>
                <label>
                    <span>Text number (optional)</span>
                    <input type="text" name="text_number" placeholder="85258" />
                </label>
            </div>
            <div class="modal-grid">
                <label>
                    <span>Email address (optional)</span>
                    <input type="email" name="contact_email" placeholder="hello@support.org" />
                </label>
                <label>
                    <span>Helpline hours</span>
                    <input type="text" name="helpline_hours" placeholder="24/7 or Mon-Fri 9am-6pm" />
                </label>
            </div>
            <div class="checkbox-grid">
                <label class="checkbox-field">
                    <input type="checkbox" name="has_helpline" />
                    <span>Helpline</span>
                </label>
                    <label class="checkbox-field">
                        <input type="checkbox" name="has_volunteers" />
                        <span>Volunteers</span>
                    </label>
                    <label class="checkbox-field">
                        <input type="checkbox" name="has_crisis_info" />
                        <span>Crisis info</span>
                    </label>
                    <label class="checkbox-field">
                        <input type="checkbox" name="has_text_support" />
                        <span>Text support</span>
                    </label>
                    <label class="checkbox-field">
                        <input type="checkbox" name="has_email_support" />
                        <span>Email support</span>
                    </label>
                    <label class="checkbox-field">
                        <input type="checkbox" name="has_live_chat" />
                        <span>Live chat</span>
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" type="submit" data-admin-charity-submit>Save charity</button>
                <button class="btn ghost" type="button" data-admin-charity-close>Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
