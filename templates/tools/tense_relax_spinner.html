{% extends "base.html" %}

{% block hero %}
<section class="spinner-hero hero-grid">
    <div class="hero-copy">
        <p class="eyebrow">New calming lab</p>
        <h1>{{ tool.title }}</h1>
        <p class="lede">{{ tool.description }}</p>
        <div class="calm-hero__actions">
            {% if tool_data %}
            <button class="btn" type="button" data-calming-complete data-calming-slug="{{ tool_data.slug }}">
                I tried this spin
            </button>
            {% endif %}
            <a class="btn ghost" href="{{ url_for('calming_tools') }}">Back to overview</a>
        </div>
        <div class="meta-row">
            <div class="meta-pill">
                <span class="pill-dot"></span>
                Auto-spins 20 rounds with soft deceleration
            </div>
            <div class="meta-pill">
                <span class="pill-dot"></span>
                Flashing highlight for the winning muscle group
            </div>
            <div class="meta-pill">
                <span class="pill-dot"></span>
                Warm pastel palette to keep everything gentle
            </div>
        </div>
    </div>
    <div class="spinner-hero__panel">
        <div class="spinner-hero__inner">
            <p class="eyebrow">Interactive focus</p>
            <h3>Let the pointer choose where to tense and relax next.</h3>
            <p class="body">Follow the highlighted slice, take a slow inhale while you squeeze that muscle group, then exhale as
                you release. Each flash is your cue to soften a little more.</p>
            <div class="hero-stats">
                {% if tool_data %}
                <div class="hero-stat">
                    <p class="microcopy">Times people have spun</p>
                    <p class="stat-number" data-calming-count="{{ tool_data.slug }}">{{ completed_count }}</p>
                </div>
                {% endif %}
                <div class="hero-stat">
                    <p class="microcopy">Body focus areas</p>
                    <p class="stat-number">8 slices • Neck to Feet</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<section class="spinner-grid">
    <article class="resource-card spinner-card">
        <div class="card-header">
            <div class="dot"></div>
            <h3>How to flow with the spinner</h3>
        </div>
        <p class="body">Move with the visuals: squeeze the highlighted area for five seconds, then melt on the exhale. Stay with
            the pastel glow and let the rhythm slow your thoughts.</p>
        {% if tool_data %}
        <ol class="breath">
            {% for step in tool_data.steps %}
            <li>{{ step }}</li>
            {% endfor %}
        </ol>
        {% endif %}
        <div class="tool-card__actions">
            {% if tool_data %}
            <button class="btn tiny" type="button" data-calming-complete data-calming-slug="{{ tool_data.slug }}">I spun it</button>
            {% endif %}
            <a class="btn ghost tiny" href="{{ url_for('calming_tools') }}">Explore other tools</a>
        </div>
    </article>

    <article class="resource-card code-card">
        <div class="card-header">
            <div class="dot"></div>
            <h3>The full Python behind the spinner</h3>
        </div>
        <p class="body">Peek under the hood—these few dozen lines power the spinning slices, pastel gradients, and gentle flashes
            that invite you to tense and release.</p>
        <pre class="code-block"><code>{% raw %}import pygame
import random
import math
import sys
import time

pygame.init()

# ------------------------------
# WINDOW (20% smaller version)
# ------------------------------
WIDTH, HEIGHT = 576, 576
SCREEN = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Tense / Relax Spinner")

# ------------------------------
# FONTS
# ------------------------------
FONT_SMALL = pygame.font.SysFont("arial", 15, bold=True)
FONT_BIG = pygame.font.SysFont("arial", 17, bold=True)

# ------------------------------
# NEW SLICE TEXT (Tense / Relax)
# ------------------------------
AREAS = [
    "Neck",
    "Shoulders",
    "Face",
    "Arms",
    "Hands",
    "Calves",
    "Feet",
    "Chest"
]

LABELS = [f"Tense / Relax\n{area}" for area in AREAS]

COLOURS = [
    (255, 182, 185),
    (255, 223, 186),
    (255, 255, 186),
    (186, 255, 201),
    (186, 225, 255),
    (210, 200, 255),
    (255, 200, 240),
    (255, 210, 200)
]

# ------------------------------
# SIZE SETTINGS (scaled 20% down)
# ------------------------------
RADIUS = 208
TEXT_RADIUS = 120
clock = pygame.time.Clock()


# -------------------------------------------------------
# DRAW SPINNER (slice 0 aligned to pointer)
# -------------------------------------------------------
def draw_spinner(angle, highlight=None, flash=False):
    num = len(LABELS)
    slice_angle = 2 * math.pi / num
    angle -= math.pi / 2  # align slice 0 under the arrow

    for i in range(num):
        start = angle + i * slice_angle
        end = start + slice_angle

        col = COLOURS[i]

        if highlight == i:
            if flash:
                col = (255, 255, 255)  # flashing white
            else:
                col = (min(col[0] + 70, 255),
                       min(col[1] + 70, 255),
                       min(col[2] + 70, 255))

        pygame.draw.pie(
            SCREEN, col,
            (WIDTH//2 - RADIUS, HEIGHT//2 - RADIUS, RADIUS*2, RADIUS*2),
            start, end
        )

        # Label lines (two lines)
        label1, label2 = LABELS[i].split("\n")

        mid = start + slice_angle / 2
        tx = WIDTH//2 + math.cos(mid) * TEXT_RADIUS
        ty = HEIGHT//2 + math.sin(mid) * TEXT_RADIUS

        l1 = FONT_SMALL.render(label1, True, (40, 40, 40))
        l2 = FONT_BIG.render(label2, True, (40, 40, 40))

        SCREEN.blit(l1, (tx - l1.get_width()//2, ty - 18))
        SCREEN.blit(l2, (tx - l2.get_width()//2, ty + 2))


# -------------------------------------------------------
# Pointer (smaller)
# -------------------------------------------------------
def draw_pointer():
    pygame.draw.polygon(
        SCREEN,
        (40, 40, 40),
        [
            (WIDTH//2, HEIGHT//2 - RADIUS - 8),
            (WIDTH//2 - 16, HEIGHT//2 - RADIUS - 40),
            (WIDTH//2 + 16, HEIGHT//2 - RADIUS - 40)
        ]
    )


# -------------------------------------------------------
# Winning slice calculation
# -------------------------------------------------------
def get_winning_slice(angle):
    num = len(LABELS)
    slice_angle = 2 * math.pi / num
    corrected = (-angle + math.pi/2) % (2 * math.pi)
    return int(corrected / slice_angle)


# -------------------------------------------------------
# MAIN — Auto Spins 20 times, 4.5 sec delay, flashes winner
# -------------------------------------------------------
def main():
    angle = 0
    highlight = None

    spins_left = 20
    spinning = False
    speed = 0
    next_spin_time = time.time()

    flash_counter = 0
    flashing = False

    FLASH_TOTAL = 14        # how many frames flash
    FLASH_SPEED = 0.12      # controls speed of flash

    while True:
        SCREEN.fill((245, 245, 255))

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()

        # Start new spin automatically
        if spins_left > 0 and not spinning and not flashing and time.time() >= next_spin_time:
            spinning = True
            highlight = None
            speed = random.uniform(0.23, 0.40)
            spins_left -= 1

        # Wheel spinning
        if spinning:
            angle += speed
            speed *= 0.992

            if speed < 0.002:
                spinning = False
                highlight = get_winning_slice(angle)
                flashing = True
                flash_counter = FLASH_TOTAL
                next_spin_time = time.time() + 4.5

        # Flashing winning slice
        flash_frame = False
        if flashing:
            flash_frame = (flash_counter % 2 == 0)
            flash_counter -= FLASH_SPEED
            if flash_counter <= 0:
                flashing = False

        # Draw components
        draw_spinner(angle, highlight, flash_frame)
        draw_pointer()

        pygame.display.update()
        clock.tick(60)


# -------------------------------------------------------
# PIE DRAW PATCH
# -------------------------------------------------------
def draw_pie(surface, color, rect, start_angle, end_angle):
    x, y, w, h = rect
    cx, cy = x + w//2, y + h//2
    r = w//2
    pts = [(cx, cy)]
    for i in range(45):
        a = start_angle + (end_angle - start_angle) * (i / 44)
        pts.append((cx + math.cos(a) * r,
                    cy + math.sin(a) * r))
    pygame.draw.polygon(surface, color, pts)


pygame.draw.pie = draw_pie
main(){% endraw %}</code></pre>
    </article>
</section>
{% endblock %}

{% block scripts %}
    <script src="/static/js/calming-common.js"></script>
{% endblock %}
